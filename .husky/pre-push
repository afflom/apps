#!/bin/sh

echo "Running essential checks for push..."
npm run typecheck && npm run lint && npm run format:check && npm run test

if [ $? -ne 0 ]; then
  echo "ERROR: Tests or checks failed. Fix issues before pushing."
  exit 1
fi

echo ""
echo "Building app for GitHub Pages deployment validation..."
npm run build

if [ $? -ne 0 ]; then
  echo "ERROR: Build failed. Fix build issues before pushing."
  exit 1
fi

echo ""
echo "Checking if GitHub repo is properly configured for deployments..."

# Simplified version that just ensures we have GitHub Pages access
# without trying to deploy directly (which happens automatically via GitHub Actions)
if [ -n "$CODESPACES" ] || [ -n "$GITHUB_CODESPACE_TOKEN" ]; then
  echo "Running in GitHub Codespace, using GitHub CLI to check repo settings..."
  
  # Try to use GitHub CLI to check for GitHub Pages settings
  gh_output=$(gh repo view --json name,hasPages 2>/dev/null)
  gh_status=$?
  
  if [ $gh_status -eq 0 ]; then
    has_pages=$(echo "$gh_output" | grep -o '"hasPages":[^,}]*' | cut -d ':' -f2)
    if [ "$has_pages" = "true" ]; then
      echo "✅ GitHub Pages is enabled for this repository. Deployments will proceed automatically."
    else
      echo "⚠️ GitHub Pages is not enabled. GitHub Actions will attempt to configure it."
    fi
  else
    echo "ℹ️ Could not check GitHub Pages status. GitHub Actions will attempt the deployment."
  fi
fi

echo "✅ GitHub Actions will deploy changes to the appropriate environment."

echo "✅ All checks passed! Push can proceed."